version: '3.5'
services:
  # Prisma server
  notification-prisma-server: # <--- change this to avoid conflict
    image: prismagraphql/prisma:1.34
    restart: always
    networks:
      - internal
    environment:
      PRISMA_CONFIG: |
        managementApiSecret: softkey
        port: 4466
        databases:
          default:
            connector: mongo 
            uri: mongodb://prisma:prisma@notification-db # <--- change this to the name of the db image like this => uri: mongodb://prisma:prisma@name
  # Main Service
  notification-service: # <--- change this to avoid conflict
    restart: always
    build: 
      context: .
      dockerfile: Dockerfile
    # command: ./wait-for-it.sh prisma:4466 -- npm run deploy #use this for production
    command: ./wait-for-it.sh prisma:4466 -- npm run dev:up  #use this for production
    volumes:
      - .:/usr/app
      - /usr/app/node_modules
      - /usr/app/generated/prisma-client
    ports:
      - "5003:4000" # <--- change this port mapping if you are running something on port 5000
    links: 
      - "notification-prisma-server:prisma" # <--- change this  to correspond with the prisma server name like this  "my-prisma-server:prisma"
    depends_on: 
      - notification-prisma-server # <--- change this to correspond with the prisma server name like this  "my-prisma-server"
    environment: 
      PRISMA_MANAGEMENT_API_SECRET: softkey
      KAFKA_CLUSTER: kafka:9092 # <-- kafka-service name as host, if kafka is in the same network else add a host mapping
    networks: 
      - internal
  notification-db: # <--- change this to avoid conflict and to correspond with the prisma server name like this  "my-prisma-server:prisma"
    image: mongo:3.6
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: prisma
      MONGO_INITDB_ROOT_PASSWORD: prisma
    networks: 
      - internal 
    volumes:
      - notification-db:/var/lib/mongo/auth #<---- change this too
volumes:
  notification-db: ~ #<---- and change this too
networks: 
  internal: # <-- create a bridge network 
    external: true
    name: internal